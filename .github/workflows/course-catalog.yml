name: Course Catalog

on:
  push:
    branch:
      - "master"
  pull_request:
    branch:
      - "master"
  workflow_dispatch: #manualmente

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Docker Build 
        run: docker build -t course-catalog:actions-0.${GITHUB_SHA} .

      - name: Unit Test      
        run: |
          docker run --rm -v "${{ github.workspace }}:/course-catalog/" course-catalog:actions-0.${GITHUB_SHA} \
            nosetests --with-xunit --with-coverage --cover-package=project test_users.py
  sonar-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Install unzip
        run: sudo apt-get install -y unzip        
      - name: Install SonarScanner
        run: |
          wget -qO- https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip \
          unzip sonar-scanner-cli-4.6.2.2472-linux.zip -d /tmp \
          export PATH="/tmp/sonar-scanner-4.6.2.2472-linux/bin:$PATH"
      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.host.url=http://35.224.51.209:9000/ \
            -Dsonar.projectKey=courseCatalog \
            -Dsonar.sources=. \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
